linux の時間管理
============================

linux の時間の仕組み
----------------------------

linux にはソフトウェアクロックとハードウェアクロックの 2 つのクロックタイプが存在する.
ハードウェアクロックはハードウェアに蓄えられた時刻（CMOS）を使って、時刻を測定している.
マーザーボードに備え付けられているボタン電池から電気を供給されているので、電気を落としてもクロックを刻み続ける.

linux 起動時にハードウェアクロックをソフトウェアクロックとして登録し、
その後はソフトウェアクロックが 10ms ごとに割り込み、ソフトウェアクロックの時刻を更新していく.
date コマンドで表示されるデータはソフトウェクロックである.

また時刻には世界協定日時とローカルタイム（地域標準日時）の 2 種類存在する.
/usr/share/zoneinfo のディレクトリにそれぞれの地域ごとの設定ファイルが存在しており、
/etc/localtime にシンボリックリンクを貼ることによって、どのローカルか決定される.

時間設定に関するコマンド
----------------------------

*ハードウェアクロックの値には UTC, ローカルタイムどちらでも設定できる.*
ハードウェクロックからはどちらの種類が設定されているか分からないので、
起動時にどの種類の値を設定しているのかを教えなければならない.
RedHat 系の場合は /etc/sysconfig/clock で設定を行う.
archlinux の場合は /etc/adjtime に保存されている.

* ハードウェクロックを表示する: `hwclock --show`
* ハードウェクロックを設定する: `hwclock --set --date="YYYY-MM-DD hh:mm:ss"`
* ハードウェアクロックの種類を設定する: 
   * ローカルタイム: `hwclock -w --local`
   * UTC: `hwclock -w --utc`
   `cat /etc/adjtime` の最後の行に設定された値が保存されている
* ハードウェクロックの時刻をソフトウェアクロックの時刻に設定する: `hwclock --systohc` (system to hardware clock)
* date コマンドで時間を調整する場合:

    $ date -s '2000-11-22 21:02:00'
    $ hwclock --systohc
    $ hwclock --show

その他
----------------------------

### ntp による時刻同期 ###

ntpdate が入ってることを確認する.

以下のサイトのいずれかを ntp の設定先とする.
（IP アドレスではなくホスト名でアクセスすることが推奨されている）

* 独立行政法人: ntp.nict.jp
* インターネットマルチフィード: ntp.jst.mfeed.ad.jp
* NTP POOL PROJECT : 
    0.jp.pool.ntp.org
    1.jp.pool.ntp.org
    2.jp.pool.ntp.org
    3.jp.pool.ntp.org

指定したサーバーと時刻の同期を行う.

    $ ntpdate [<IP> or <HostName>]
    
指定したサーバーと時刻の差分を表示する

    $ ntpdate -q [<IP> or <HostName>]
