
iptables の設定
============================

内部ネットワークのサーバーを外部に公開する
----------------------------

* ローカルLanのサーバーをポートフォワーディングで公開サーバーに設定:
持っているIPアドレスは一つだけで、**INNERサーバーはローカルネットワーク**にあるとする。
    * $PUB_IP: ファイヤーウォールの外部アドレス
    * $PUB_PORT: ファイヤーウォールの外部向けポート
    * $INNER_IP: INNERサーバーの持つ内部向けアドレス
    * $INNER_PORT: INNERサーバーの待ち受けポート
    * $LAN_IP: ファイヤーウォールの内部向けアドレス

    # 外部クライアントからのアクセスフォワード
    $ iptables -t nat -A PREROUTING -p tcp --dst $PUB_IP --dport $PUB_PORT -j DNAT --to-destination $INNER_IP:$INNER_PORT
    
    # 内部ネットワークからのアクセスフォワード
    $ iptables -t nat -A POSTROUTING -p tcp --dst $INNER_IP --dport $INNER_PORT -j SNAT --to-source $LAN_IP
    
    # ファイヤーウォール自身でアクセスする場合の記述
    $ iptables -t nat -A OUTPUT --dst $PUB_IP -p tcp --dport $INNER_PORT -j DNAT --to-destination $INNER_IP:$INNER_PORT

PREROUTINGチェインはDestinationアドレスを変換するもので、基本的に**外部から入ってくるパケット用**。
POSTROUTINGチェインは送信元アドレスを変換するもので、基本的に**外部へ出ていくパケット用**。

上記設定の完了後, 公開サーバーから内部向けサーバーへそのままポートフォワーディングする場合は, IPの書き換え設定をonにしなければならない。

    $ sudo sysctl net.ipv4.ip_forward=1 
    $ sudo emacs /etc/sysctl.conf
    net.ipv4.ip_forward = 0
    ↓
    net.ipv4.ip_forward = 1    
    $ sudo sysctl -p

内部ネットワークをマスカーレード
----------------------------

$iternal_ip にソース側ネットワークアドレスを指定する。（例: 192.168.0.0/24）

    $ sudo iptables -t nat -A POSTROUTING -o eth0 -s $internal_ip -j MASQUERADE


オプション
----------------------------

* iptablesの統計を調べたい時: `iptables -nxvL`


その他
----------------------------

### ftp のpasiveモードを許可する ###

`/etc/sysconfig/iptable-config`に以下の行を追加する

    IPTABLES_MODULES="ip_conntrack_ftp"

また、`/etc/sysconfig/iptables`に以下の記述を追加する。（特に*RELATED*が重要）

    -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT

その後iptablesの再起動を行い正常に接続できるようになったかテストする。

### debianでのiptables初期化 ###

    iptables -t filter -F
    iptables -t nat -F
    iptables -X
    iptables -Z


参考サイト
----------------------------

* [DNATターゲット](http://www.asahi-net.or.jp/~aa4t-nngk/ipttut/output/dnattarget.html)
